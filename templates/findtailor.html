{% extends "base.html" %}
{% load static %}
{% block title %}findtailor{% endblock %}

{% block content %}
  
<main>
    <section>
        <div style="margin:0; padding:0; background-color:#e6f2ff; min-height:60vh; display:flex; flex-direction:column; align-items:center; padding:40px 20px; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <div style="width:100%; max-width:800px;margin-top:60px; text-align:center;">
                <h1 style="color:#1a3c6e; font-size:2.5rem; margin-top:40px;margin-bottom:20px; font-weight:600;">Find Your Perfect Tailor</h1>
                
                <p style="color:#2c5282; font-size:1.1rem; line-height:1.6; margin-bottom:40px; max-width:600px; margin-left:auto; margin-right:auto;">
                    Search through hundreds of skilled tailors across Bangladesh. Filter by location, specialization, and pricing to find the perfect match for your needs.
                </p>
                
                <div style="width:100%; max-width:600px; margin:0 auto 30px; position:relative;">
                    <input type="text" id="searchInput" placeholder="Search by tailor name, location, or specialization..." 
                        style="width:100%; padding:16px 20px; font-size:1rem; border:2px solid #a0c4ff; border-radius:50px; outline:none; transition:all 0.3s ease; box-shadow:0 4px 6px rgba(0,0,0,0.05);">
                </div>
                
                <div id="resultsContainer" style="width:100%; max-width:600px; margin:0 auto; text-align:left; display:none;">
                    <h2 style="color:#1a3c6e; margin-bottom:15px;">Search Results</h2>
                    <div id="resultsList" style="background:white; border-radius:10px; padding:20px; box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>
                </div>
            </div>
        </div>
    </section>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const searchResultsContainer = document.getElementById('searchResultsContainer');
            const searchResultsList = document.getElementById('searchResultsList');
            const tailorCards = document.querySelectorAll('.tailor-card');
            const mainTailorGrid = document.querySelector('div[style*="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr))"]');
            
            // Real-time search functionality
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    searchResultsContainer.style.display = 'none';
                    // Show all tailor cards in the main grid
                    tailorCards.forEach(card => {
                        card.style.display = 'flex';
                    });
                    updateMainCount();
                    return;
                }
                
                let foundResults = false;
                let matchCount = 0;
                
                // Check which tailors match the search and hide/show accordingly
                tailorCards.forEach(card => {
                    const tailorName = card.querySelector('h3')?.textContent.toLowerCase() || '';
                    const tailorLocation = card.querySelector('.fa-map-marker-alt')?.parentNode?.textContent.toLowerCase() || '';
                    const tailorSpecialization = card.querySelector('.fa-tag')?.parentNode?.textContent.toLowerCase() || '';
                    const tailorExpertise = card.querySelector('.fa-briefcase')?.parentNode?.textContent.toLowerCase() || '';
                    const tailorPrice = card.querySelector('.fa-money-bill-wave')?.parentNode?.textContent.toLowerCase() || '';
                    
                    const matches = tailorName.includes(searchTerm) || 
                                tailorLocation.includes(searchTerm) || 
                                tailorSpecialization.includes(searchTerm) ||
                                tailorExpertise.includes(searchTerm) ||
                                tailorPrice.includes(searchTerm);
                    
                    if (matches) {
                        card.style.display = 'flex';
                        matchCount++;
                        foundResults = true;
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                if (foundResults) {
                    searchResultsContainer.style.display = 'none'; // Hide search results container
                    updateMainCount(matchCount);
                } else {
                    searchResultsContainer.style.display = 'block';
                    searchResultsList.innerHTML = '<p style="text-align:center; color:#718096; padding:20px;">No tailors found matching your search criteria.</p>';
                    document.querySelector('#searchResultsContainer h2').textContent = 'Search Results (0 found)';
                    updateMainCount(0);
                }
            });
            
            function updateMainCount(filteredCount = null) {
                const countElement = document.getElementById('mainCount');
                if (countElement) {
                    if (filteredCount !== null) {
                        countElement.textContent = `${filteredCount} tailors found`;
                    } else {
                        const allVisibleCards = document.querySelectorAll('.tailor-card[style="display: flex;"]').length;
                        countElement.textContent = `${allVisibleCards} tailors found`;
                    }
                }
            }
            
            // Also search on Enter key press
            searchInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    this.dispatchEvent(new Event('input'));
                }
            });
            
            // Clear search when page loads
            window.addEventListener('load', function() {
                searchInput.value = '';
                searchResultsContainer.style.display = 'none';
                updateMainCount();
            });
        });
    </script>

    <!--Tailor Section  -->
    <section style="display: flex; gap: 20px; padding: 20px;">
        <!-- Filter Sidebar -->
        <aside style="max-height: 900px; overflow-y: auto; width: 300px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <!-- Location Filter -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #1a3c6e; margin-bottom: 15px; font-size: 1.2rem;">Location</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    {% for location in locations %}
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="location" value="{{ location }}" style="cursor: pointer;" class="filter-checkbox" data-filter-type="location">
                        <span style="color: #4a5568;">{{ location }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Specialization Filter -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #1a3c6e; margin-bottom: 15px; font-size: 1.2rem;">Specialization</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    {% for category in categories %}
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="specialization" value="{{ category.0 }}" style="cursor: pointer;" class="filter-checkbox" data-filter-type="category">
                        <span style="color: #4a5568;">{{ category.1 }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- Price Filter -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: #1a3c6e; margin-bottom: 15px; font-size: 1.2rem;">Price Range</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="price" value="0-500" style="cursor: pointer;" class="filter-radio" data-filter-type="price">
                        <span style="color: #4a5568;">Under ৳500</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="price" value="500-1000" style="cursor: pointer;" class="filter-radio" data-filter-type="price">
                        <span style="color: #4a5568;">৳500 - ৳1000</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="price" value="1000-2000" style="cursor: pointer;" class="filter-radio" data-filter-type="price">
                        <span style="color: #4a5568;">৳1000 - ৳2000</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="price" value="2000+" style="cursor: pointer;" class="filter-radio" data-filter-type="price">
                        <span style="color: #4a5568;">Above ৳2000</span>
                    </label>
                </div>
            </div>

            <!-- Clear Filters Button -->
            <button id="clearFilters" style="width: 100%; padding: 10px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                Clear All Filters
            </button>
        </aside>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const tailorCards = document.querySelectorAll('.tailor-card');
                const filterCheckboxes = document.querySelectorAll('.filter-checkbox');
                const filterRadios = document.querySelectorAll('.filter-radio');
                const clearFiltersBtn = document.getElementById('clearFilters');
                const searchInput = document.getElementById('searchInput');
                const searchResultsContainer = document.getElementById('searchResultsContainer');

                // Store current filter states
                let activeFilters = {
                    locations: [],
                    categories: [],
                    price: null
                };

                function filterKey(filterType) {
                    if (filterType === 'category') return 'categories';
                    if (filterType === 'location') return 'locations';
                    return filterType + 's';
                }

                // Filter functionality
                function applyFilters() {
                    const searchTerm = (searchInput ? searchInput.value : '').toLowerCase().trim();

                    tailorCards.forEach(card => {
                        const tailorLocation = (card.getAttribute('data-location') || '').toLowerCase();
                        const tailorCategory = String(card.getAttribute('data-category') || '').toLowerCase();
                        const tailorPrice = parseFloat(card.getAttribute('data-price')) || 0;

                        // Location match
                        const locationMatch = activeFilters.locations.length === 0 ||
                            activeFilters.locations.some(filterLocation =>
                                tailorLocation.includes(filterLocation.toLowerCase())
                            );

                        // Category match (exact match against category value)
                        const categoryMatch = activeFilters.categories.length === 0 ||
                            activeFilters.categories.some(filterCategory => {
                                return tailorCategory === String(filterCategory).toLowerCase();
                            });

                        // Price match (supports "min-max" and "min+")
                        let priceMatch = true;
                        if (activeFilters.price) {
                            const val = activeFilters.price;
                            if (val.includes('-')) {
                                const parts = val.split('-');
                                const min = parseInt(parts[0]) || 0;
                                const max = parseInt(parts[1]) || Number.MAX_SAFE_INTEGER;
                                priceMatch = tailorPrice >= min && tailorPrice <= max;
                            } else if (val.endsWith('+')) {
                                const min = parseInt(val.replace('+', '')) || 0;
                                priceMatch = tailorPrice >= min;
                            } else {
                                priceMatch = true;
                            }
                        }

                        // Search match
                        const tailorName = (card.querySelector('h3')?.textContent || '').toLowerCase();
                        const tailorSpecialization = (card.querySelector('.fa-tag')?.parentNode?.textContent || '').toLowerCase();
                        const searchMatch = searchTerm === '' ||
                            tailorName.includes(searchTerm) ||
                            tailorLocation.includes(searchTerm) ||
                            tailorCategory.includes(searchTerm) ||
                            tailorSpecialization.includes(searchTerm);

                        if (locationMatch && categoryMatch && priceMatch && searchMatch) {
                            card.style.display = 'flex';
                        } else {
                            card.style.display = 'none';
                        }
                    });

                    updateMainCount();
                    updateSearchResults();
                }

                // Update main count using computed style (more reliable)
                function updateMainCount() {
                    const visibleCount = Array.from(tailorCards).filter(c => getComputedStyle(c).display !== 'none').length;
                    const countElement = document.getElementById('mainCount');
                    if (countElement) {
                        countElement.textContent = `${visibleCount} tailors found`;
                    }
                }

                function updateSearchResults() {
                    const searchTerm = (searchInput ? searchInput.value : '').toLowerCase().trim();
                    const visibleCards = Array.from(tailorCards).filter(c => getComputedStyle(c).display !== 'none');
                    if (searchTerm !== '') {
                        searchResultsContainer.style.display = 'block';
                        const header = document.querySelector('#searchResultsContainer h2');
                        if (header) header.textContent = `Search Results (${visibleCards.length} found)`;
                    } else {
                        searchResultsContainer.style.display = 'none';
                    }
                }

                // Event listeners for checkboxes
                filterCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const filterType = this.getAttribute('data-filter-type');
                        const value = this.value;
                        const key = filterKey(filterType);

                        if (this.checked) {
                            if (!activeFilters[key].includes(value)) activeFilters[key].push(value);
                        } else {
                            const idx = activeFilters[key].indexOf(value);
                            if (idx > -1) activeFilters[key].splice(idx, 1);
                        }

                        applyFilters();
                    });
                });

                // Event listeners for radio buttons
                filterRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            activeFilters.price = this.value;
                        }
                        applyFilters();
                    });
                });

                // Clear all filters
                clearFiltersBtn.addEventListener('click', function() {
                    filterCheckboxes.forEach(cb => cb.checked = false);
                    filterRadios.forEach(r => r.checked = false);
                    activeFilters = { locations: [], categories: [], price: null };
                    applyFilters();
                });

                // Search input event listener
                if (searchInput) {
                    searchInput.addEventListener('input', applyFilters);
                    searchInput.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') event.preventDefault();
                    });
                }

                // Initialize
                applyFilters();
            });
        </script>

        <!-- Main Content -->
        <div style="flex: 1;">
            <!-- Header with count and sort -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 10px; ">
                <div style="color: #1a3c6e; font-size: 1.1rem; font-weight: 600;" id="mainCount">
                    {{ tailors.count }} tailors found
                </div>
                {% comment %} <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: #4a5568;">Sort by:</span>
                    <select style="padding: 8px 12px; border: 1px solid #a0c4ff; border-radius: 5px; outline: none; cursor: pointer;">
                        <option value="rating">Rating</option>
                        <option value="experience">Experience</option>
                        <option value="price_low">Price: Low to High</option>
                        <option value="price_high">Price: High to Low</option>
                    </select>
                </div> {% endcomment %}
            </div>
            <!-- Tailor Cards Grid -->
            
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;overflow-y: auto;max-height: 900px;">
                {% for tailor in tailors %}
                    {% if tailor.user.id != user.id %}
                        <div class="tailor-card" 
                            data-rating="{{ tailor.rating|default:'0' }}" 
                            data-price="{{ tailor.price|default:'0' }}" 
                            data-location="{{ tailor.district }}" 
                            data-category="{{ tailor.category }}"
                            style="background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column;">
                            <!-- Profile Picture as the main image -->
                            <div style="position: relative; height: 180px; overflow: hidden; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                                {% if tailor.profile_picture %}
                                    <img src="{{ tailor.profile_picture.url }}" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                    <img src="{% static 'images/default-profile.jpg' %}" alt="Default Picture" style="width: 100%; height: 100%; object-fit: cover;">
                                {% endif %}
                                
                                <!-- Rating Badge -->
                                <div style="position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 20px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                                        ⭐ {{ tailor.rating|default:"0" }}
                                </div>
                                
                                <!-- Location Badge -->
                                <div style="position: absolute; bottom: 12px; left: 12px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 20px; font-size: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
                                    <i class="fas fa-map-marker-alt" style="margin-right: 4px; color: #7eb6fa;"></i> {{ tailor.district|truncatewords:2 }}
                                </div>
                            </div>
                            <!-- Content with Info -->
                            <div style="padding: 16px; text-align: left;">
                                <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #0a2342; font-weight: 700;">{{ tailor.user.first_name }} {{ tailor.user.last_name }}</h3>
                                
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="width: 24px; height: 24px; background: #f0f5ff; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                                        <i class="fas fa-tag" style="color: #194afb; font-size: 12px;"></i>
                                    </div>
                                    <p style="margin: 0; font-size: 14px; color: #4a5568;">{{ tailor.get_category_display }}</p>
                                </div>
                                
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <div style="width: 24px; height: 24px; background: #f0f5ff; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                                        <i class="fas fa-briefcase" style="color: #194afb; font-size: 12px;"></i>
                                    </div>
                                    <p style="margin: 0; font-size: 14px; color: #4a5568;">{{ tailor.expertise }} level</p>
                                </div>
                                
                                <div style="display: flex; align-items: center; margin-bottom: 16px;">
                                    <div style="width: 24px; height: 24px; background: #f0f5ff; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 8px;">
                                        <i class="fas fa-money-bill-wave" style="color: #194afb; font-size: 12px;"></i>
                                    </div>
                                    <p style="margin: 0; font-size: 14px; color: #4a5568; font-weight: 600;">Starts from ৳{{ tailor.price|default:"N/A" }}</p>
                                </div>

                                {% if user.is_authenticated %}
                                <button class="open-modal-btn" type="button"
                                    data-id="{{ tailor.id }}"
                                    data-url="{% url 'create_custom_orders' tailor.id %}"
                                    data-name="{{ tailor.user.first_name }} {{ tailor.user.last_name }}"
                                    data-image="{% if tailor.profile_picture %}{{ tailor.profile_picture.url }}{% else %}{% static 'images/default-profile.jpg' %}{% endif %}"
                                    data-shop="{{ tailor.business_name }}"
                                    data-expertise="{{ tailor.expertise_details }}"
                                    data-location="{{ tailor.business_location }}"
                                    data-rating="{{ tailor.rating|default:'N/A' }}"
                                    style="width: 100%; padding: 10px; background-color: #194afb; color: white; text-decoration: none; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background-color 0.2s;">
                                    View Profile
                                </button>

                                <div id="hireModal{{ tailor.id }}" class="hire-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 9999; font-family: 'Arial', sans-serif;">
                                        <div style="background: #fff; padding: 30px; border-radius: 8px; width: 700px; max-width: 95%; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;">
                                            <!-- Close Button -->
                                            <span id="closeModal" class="close-modal" data-modal-id="hireModal{{ tailor.id }}" style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 24px; color: #888; font-weight: bold;">
                                                ✖
                                            </span>

                                            <!-- Modal Title -->
                                            <h3 id="modalTitle" style="font-size: 26px; color: #333; margin-bottom: 20px; font-weight: 700;">Order Tailor</h3>

                                            <!-- Tailor Information Section -->
                                            <div id="tailorInfo" style="margin-bottom: 25px; color: #555; display: flex; gap: 20px;">

                                            <!-- Left Side - Profile Picture -->
                                            <div style="flex: 0 0 150px;">
                                                <img id="tailorImage" src="{{ tailor.profile_picture.url }}" alt="Profile Picture"
                                                    style="width: 150px; height: 200px; border-radius: 10px; object-fit: cover; border: 2px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                            </div>
                                            
                                            <!-- Right Side - Details -->
                                            <div style="flex: 1;">
                                                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                                    <!-- Column 1 -->
                                                    <div>
                                                        <p style="margin: 5px 0; display: flex; align-items: center;">
                                                            <i class="fas fa-user" style="margin-right: 8px; color: #666; width: 20px;"></i>
                                                            <strong>Name: </strong>
                                                            <span id="tailorName" style="margin-left: 5px;">{{ tailor.user.first_name }} {{ tailor.user.last_name }}</span>
                                                        </p>
                                                        <p style="margin: 5px 0; display: flex; align-items: center;">
                                                            <i class="fas fa-store" style="margin-right: 8px; color: #666; width: 20px;"></i>
                                                            <strong>Shop: </strong>
                                                            <span id="tailorshopname" style="margin-left: 5px;">{{ tailor.business_name }}</span>
                                                        </p>
                                                    </div>
                                                    
                                                    <!-- Column 2 -->
                                                    <div>
                                                        <p style="margin: 5px 0; display: flex; align-items: center;">
                                                            <i class="fas fa-map-marker-alt" style="margin-right: 8px; color: #666; width: 20px;"></i>
                                                            <strong>Location: </strong>
                                                            <span id="tailorLocation" style="margin-left: 5px;">{{ tailor.business_location }}</span>
                                                        </p>
                                                        <p style="margin: 5px 0; display: flex; align-items: center;">
                                                            <i class="fas fa-star" style="margin-right: 8px; color: #666; width: 20px;"></i>
                                                            <strong>Rating: </strong>
                                                            <span id="tailorRating" style="margin-left: 5px;">{{ tailor.rating|default:"N/A" }} ⭐</span>
                                                        </p>
                                                    </div>
                                                    
                                                    <!-- Column 3 -->
                                                    <div>
                                                        <p style="margin: 5px 0; display: flex; align-items: center;">
                                                            <i class="fas fa-briefcase" style="margin-right: 8px; color: #666; width: 20px;"></i>
                                                            <strong>Experience: </strong>
                                                            <span style="margin-left: 5px;">{{ tailor.expertise }} level</span>
                                                        </p>
                                                        <p style="margin: 5px 0; display: flex; align-items: center;">
                                                            <i class="fas fa-tag" style="margin-right: 8px; color: #666; width: 20px;"></i>
                                                            <strong>Starts from: </strong>
                                                            <span style="margin-left: 5px;">৳{{ tailor.price|default:"N/A" }}</span>
                                                        </p>
                                                    </div>
                                                </div>
                                                
                                                <!-- Services Offered -->
                                                <div style="margin-top: 15px;">
                                                    <h4 style="margin-bottom: 8px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                                                        <i class="fas fa-list" style="margin-right: 8px;"></i>Services Offered
                                                    </h4>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                                        {% for service in tailor.services_offered.splitlines %}
                                                            <span style="background: #f0f5ff; color: #194afb; padding: 4px 10px; border-radius: 15px; font-size: 14px;">
                                                                {{ service }}
                                                            </span>
                                                        {% endfor %}
                                                    </div>

                                                    <div class="favorite-icon" 
                                                        style=" top: 16px; right: 16px; cursor: pointer; font-size: 24px; color: {% if tailor.id in favorite_tailor_ids %} #e74c3c {% else %} #ccc {% endif %}; transition: all 0.3s ease;" 
                                                        data-tailor-id="{{ tailor.id }}" 
                                                        onclick="toggleFavorite(this)">
                                                        {% if tailor.id in favorite_tailor_ids %}♥{% else %}♡{% endif %}
                                                    </div>

                                                    <script>
                                                        function toggleFavorite(icon) {
                                                            const tailorId = icon.getAttribute('data-tailor-id');
                                                            const isCurrentlyFilled = icon.style.color === 'rgb(231, 76, 60)';
                                                            
                                                            // Toggle the visual state immediately for better UX
                                                            if (isCurrentlyFilled) {
                                                                icon.style.color = '#ccc';
                                                                icon.textContent = '♡';
                                                            } else {
                                                                icon.style.color = '#e74c3c';
                                                                icon.textContent = '♥';
                                                            }
                                                            
                                                            // Send AJAX request to the server
                                                            fetch(`/favorites/toggle/${tailorId}/`, {
                                                                method: 'POST',
                                                                headers: {
                                                                    'X-CSRFToken': getCookie('csrftoken'),
                                                                    'Content-Type': 'application/json',
                                                                },
                                                            })
                                                            .then(response => {
                                                                if (!response.ok) {
                                                                    // If the request failed, revert the visual state
                                                                    if (isCurrentlyFilled) {
                                                                        icon.style.color = '#e74c3c';
                                                                        icon.textContent = '♥';
                                                                    } else {
                                                                        icon.style.color = '#ccc';
                                                                        icon.textContent = '♡';
                                                                    }
                                                                    
                                                                    // Check if it's an authentication error
                                                                    if (response.status === 401) {
                                                                        alert('Please log in to add favorites');
                                                                    } else {
                                                                        alert('Failed to update favorite status');
                                                                    }
                                                                    throw new Error('Failed to update favorite status');
                                                                }
                                                                return response.json();
                                                            })
                                                            .then(data => {
                                                                console.log('Favorite status updated:', data);
                                                            })
                                                            .catch(error => {
                                                                console.error('Error:', error);
                                                            });
                                                        }

                                                        // Function to get CSRF token from cookies
                                                        function getCookie(name) {
                                                            let cookieValue = null;
                                                            if (document.cookie && document.cookie !== '') {
                                                                const cookies = document.cookie.split(';');
                                                                for (let i = 0; i < cookies.length; i++) {
                                                                    const cookie = cookies[i].trim();
                                                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                                                        break;
                                                                    }
                                                                }
                                                            }
                                                            return cookieValue;
                                                        }
                                                    </script>


                                                </div>
                                            </div>
                                        </div>

                                        <!-- Navigation Tabs -->
                                        <div style="margin: 20px 0; border-bottom: 1px solid #eee;">
                                            <button class="tab-btn active" data-tab="about" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #194afb; border-bottom: 2px solid #194afb;">About</button>
                                            <button class="tab-btn" data-tab="portfolio" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: normal; color: #666;">Portfolio</button>
                                            
                                            <button class="tab-btn" data-tab="contact" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: normal; color: #666;">Contact</button>
                                        </div>

                                        <!-- Tab Content -->
                                        <div id="aboutTab" class="tab-content" style="display: block;">
                                            <p>{{ tailor.business_description }}</p>
                                        </div>

                                        <div id="portfolioTab" class="tab-content" style="display: none;">
                                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 10px;">
                                                {% for a in products %}
                                                    {% if a.tailor.id == tailor.id %}
                                                        <div style="position: relative; overflow: hidden; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                                            <a href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#orderModal{{ a.id }}" style="display:block;">
                                                                {% if a.images.all %}
                                                                    <div style="width: 100%; height: 200px; overflow: hidden;">
                                                                        <img src="{{ a.images.first.image.url }}" alt="{{ a.title }}" 
                                                                            style="width: 100%; height: 200px; object-fit: cover; transition: transform 0.3s ease;">
                                                                    </div>
                                                                {% else %}
                                                                    <div style="width: 100%; height: 200px; background: #f1f1f1; display: flex; align-items: center; justify-content: center; color: #777;">
                                                                        <i class="fas fa-image" style="font-size: 40px;"></i>
                                                                    </div>
                                                                {% endif %}
                                                            </a>
                                                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; padding: 8px; text-align: center;">
                                                                {{ a.name }} - ৳{{ a.price }}
                                                            </div>
                                                        </div>





                                                        <!-- Modal for each portfolio product -->
                                                        <div id="orderModal{{ a.id }}" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
                                                            <div style="background: #fff; max-width: 1000px; height: 100vh; width: 90%; margin: auto; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 30px; position: relative; display: flex; flex-wrap: wrap; gap: 20px;">
                                                                <!-- Close button moved inside the white content div -->
                                                                <span onclick="document.getElementById('orderModal{{ a.id }}').style.display='none'" 
                                                                    style="position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 24px; color: #333; z-index: 1;">
                                                                    &times;
                                                                </span>
                                                                <!-- Left: Image Section -->
                                                                <div style="flex: 1 1 45%; display: flex; flex-direction: column; align-items: center;">
                                                                    <!-- Main Image -->
                                                                    {% if a.images.all|length > 0 %}
                                                                        <img id="mainImage{{ a.id }}" src="{{ a.images.all.0.image.url }}" alt="{{ a.name }}" style="width: 400px; max-height: 560px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; padding-top: 10px;">
                                                                    {% else %}
                                                                        <div style="width: 100%; height: 400px; background: #eee; border-radius: 8px;"></div>
                                                                    {% endif %}

                                                                    <!-- Thumbnail Images -->
                                                                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                                                                        {% for image in a.images.all %}
                                                                            <img src="{{ image.image.url }}" onclick="changeMainImage('{{ a.id }}', '{{ image.image.url }}')" style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid #ddd;">
                                                                        {% endfor %}
                                                                    </div>
                                                                </div>

                                                                <!-- Right: Product Info -->
                                                                <div style="flex: 1 1 50%; display: flex; flex-direction: column; gap: 0px; padding: 5px 0;">
                                                                    <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 0;">{{ a.name }}</h2>
                                                                    <p style="font-size: 20px; font-weight: bold; color: #2563EB; margin-bottom: 0;">৳{{ a.price }}</p>

                                                                    <p style="font-size: 15px; color: #555; margin-bottom: 0;">{{ a.description }}</p>

                                                                    <div style="margin-bottom: 0;">
                                                                        <h4 style="margin-bottom: 0; font-size: 16px;">Features</h4>
                                                                        <ul style="list-style: none; padding-left: 0; font-size: 14px; color: #444; margin-top: 0;">
                                                                            <li>✔ Premium Cotton Fabric</li>
                                                                            <li>✔ Traditional Embroidery</li>
                                                                            <li>✔ Comfortable Fit</li>
                                                                            <li>✔ Machine Washable</li>
                                                                        </ul>
                                                                    </div>

                                                                    <!-- Size Selection -->
                                                                    <div style="margin-bottom: 5px;">
                                                                        <h4 style="margin-bottom: 3px; font-size: 16px;">Select Size</h4>
                                                                        <div id="sizeContainer{{ a.id }}" style="display: flex; gap: 8px;">
                                                                            <button type="button" class="size-btn selected" data-size="S" onclick="selectSize(this, '{{ a.id }}')" style="width: 40px; height: 40px; border: 2px solid #0216adff; background-color: #0216adff; color: white; border-radius: 4px; cursor: pointer; font-weight: bold;display: flex;align-items: center;justify-content: center;">S</button>
                                                                            
                                                                            <button type="button" class="size-btn" data-size="M" onclick="selectSize(this, '{{ a.id }}')" style="width: 40px; height: 40px; border: 2px solid #ddd; background-color: white; color: #333; border-radius: 4px; cursor: pointer; font-weight: bold;display: flex;align-items: center;justify-content: center;">M</button>
                                                                            
                                                                            <button type="button" class="size-btn" data-size="L" onclick="selectSize(this, '{{ a.id }}')" style="width: 40px; height: 40px; border: 2px solid #ddd; background-color: white; color: #333; border-radius: 4px; cursor: pointer; font-weight: bold;display: flex;align-items: center;justify-content: center;">L</button>
                                                                            
                                                                            <button type="button" class="size-btn" data-size="XL" onclick="selectSize(this, '{{ a.id }}')" style="width: 40px; height: 40px; border: 2px solid #ddd; background-color: white; color: #333;border-radius: 4px; cursor: pointer; font-weight: bold;display: flex;align-items: center;justify-content: center;">XL</button>
                                                                            
                                                                            <button type="button" class="size-btn" data-size="XXL" onclick="selectSize(this, '{{ a.id }}')" style="
                                                                                width: 40px; height: 40px; border: 2px solid #ddd; background-color: white;color: #333; border-radius: 4px; cursor: pointer; font-weight: bold;display: flex;align-items: center;justify-content: center;">XXL</button>
                                                                        </div>
                                                                    </div>

                                                                    <script>
                                                                        // Function to handle size selection
                                                                        function selectSize(element, productId) {
                                                                            // Remove selected class from all buttons
                                                                            const buttons = document.querySelectorAll(`#sizeContainer${productId} .size-btn`);
                                                                            buttons.forEach(btn => {
                                                                                btn.classList.remove('selected');
                                                                                btn.style.backgroundColor = 'white';
                                                                                btn.style.borderColor = '#ddd';
                                                                                btn.style.color = '#333';
                                                                            });
                                                                            
                                                                            // Add selected class to clicked button
                                                                            element.classList.add('selected');
                                                                            element.style.backgroundColor = '#0216adff';
                                                                            element.style.borderColor = '#0216adff';
                                                                            element.style.color = 'white';
                                                                            
                                                                            // Update the hidden size field
                                                                            document.getElementById(`hiddenSize${productId}`).value = element.dataset.size;
                                                                            
                                                                            // Update the size display in the order form
                                                                            const sizeDisplay = document.getElementById(`selectedSizeDisplay${productId}`);
                                                                            if (sizeDisplay) {
                                                                                sizeDisplay.textContent = element.dataset.size;
                                                                            }
                                                                        }
                                                                    </script>

                                                                    <!-- Quantity -->
                                                                    <div style="margin-bottom: 8px;">
                                                                        <h4 style="margin-bottom: 3px; font-size: 16px;">Quantity</h4>
                                                                        <div style="display: flex; align-items: center; gap: 5px;">
                                                                            <!-- Minus Button -->
                                                                            <button type="button" onclick="changeQty{{ a.id }}(-1)" style="width: 35px; height: 35px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; font-size: 18px; cursor: pointer; transition: 0.2s;" onmouseover="this.style.background='#ddd'" onmouseout="this.style.background='#f0f0f0'">-</button>

                                                                            <!-- Quantity Input -->
                                                                            <input id="qtyInput{{ a.id }}" type="number" name="quantity" value="1" min="1" max="4" 
                                                                                style="width: 60px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
                                                                            
                                                                            <!-- Plus Button -->
                                                                            <button type="button" onclick="changeQty{{ a.id }}(1)" style="width: 35px; height: 35px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; font-size: 18px; cursor: pointer; transition: 0.2s;" onmouseover="this.style.background='#ddd'" onmouseout="this.style.background='#f0f0f0'">+</button>
                                                                        </div>
                                                                    </div>

                                                                    <p style="font-size: 14px; color: #666; margin-bottom: 2px;">🚚 Delivery Time: 3-7 days</p>
                                                                    <p style="font-size: 14px; color: #666; margin-bottom: 0;">📍 Made in Dhaka</p>

                                                                    <!-- Buttons -->
                                                                    <div style="display: flex; gap: 10px; margin-top: 5px; margin-bottom: 5px;">
                                                                            
                                                                        <button type="button" onclick="openOrderFormModal('{{ a.id }}')" 
                                                                                style="padding: 8px 16px; background: #2563EB; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
                                                                            Order Now
                                                                        </button>

                                                                        <!-- Order Form Modal -->
                                                                        <div id="orderFormModal{{ a.id }}" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto;">
                                                                            <div style="background: #fff; max-width: 800px; margin: 50px auto; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 30px; position: relative;">
                                                                                <span onclick="document.getElementById('orderFormModal{{ a.id }}').style.display='none'" 
                                                                                    style="position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 24px; color: #333; z-index: 1;">
                                                                                    &times;
                                                                                </span>
                                                                                
                                                                                <h2 style="font-size: 24px; margin-bottom: 20px; text-align: center;">Place Order</h2>
                                                                                
                                                                                <form id="orderForm{{ a.id }}" method="POST" action="{% url 'create_order' %}">
                                                                                    {% csrf_token %}
                                                                                    
                                                                                    <!-- Hidden fields for product and tailor -->
                                                                                    <input type="hidden" name="product_id" value="{{ a.id }}">
                                                                                    <input type="hidden" name="tailor_id" value="{{ a.tailor.id }}">
                                                                                    <input type="hidden" name="quantity" id="hiddenQuantity{{ a.id }}" value="1">
                                                                                    <input type="hidden" name="price" value="{{ a.price }}">
                                                                                    <input type="hidden" name="size" id="hiddenSize{{ a.id }}" value="">
                                                                                    
                                                                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                                                                        <!-- Full Name -->
                                                                                        <div>
                                                                                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Full Name</label>
                                                                                            <input type="text" name="full_name" required 
                                                                                                value="{{ user.get_full_name }}" 
                                                                                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                                                                                                placeholder="Enter your full name">
                                                                                        </div>
                                                                                        
                                                                                        <!-- Phone -->
                                                                                        <div>
                                                                                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Phone Number</label>
                                                                                            <input type="tel" name="phone" required 
                                                                                                value="{{ user.customer.phone }}" 
                                                                                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                                                                                                placeholder="Enter your phone number">
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <!-- Address -->
                                                                                    <div style="margin-bottom: 20px;">
                                                                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Address</label>
                                                                                        <textarea name="address" rows="3" required 
                                                                                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                                                                                                placeholder="Enter your delivery address">{{ user.customer.address }}</textarea>
                                                                                    </div>
                                                                                    
                                                                                    <!-- Special Instructions -->
                                                                                    <div style="margin-bottom: 20px;">
                                                                                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Special Instructions</label>
                                                                                        <textarea name="special_instructions" rows="3" maxlength="500" 
                                                                                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                                                                                                placeholder="Any special requests or customizations..."></textarea>
                                                                                        <p style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">
                                                                                            <span id="charCount{{ a.id }}">0</span>/500 characters
                                                                                        </p>
                                                                                    </div>
                                                                                    
                                                                                    <div style="border-top: 1px solid #eee; padding-top: 15px; margin-bottom: 20px;">
                                                                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                                                                            <div>
                                                                                                <p style="margin: 5px 0;">Item:</p>
                                                                                                <p style="margin: 5px 0;">Size:</p>
                                                                                                <p style="margin: 5px 0;">Quantity:</p>
                                                                                                <p style="margin: 5px 0; font-weight: bold;">Total:</p>
                                                                                            </div>
                                                                                            <div style="text-align: right;">
                                                                                                <p style="margin: 5px 0;">{{ a.category }}</p>
                                                                                                <p style="margin: 5px 0;" id="selectedSizeDisplay{{ a.id }}">S</p>
                                                                                                <p style="margin: 5px 0;" id="selectedQuantityDisplay{{ a.id }}">1</p>
                                                                                                <p style="margin: 5px 0; font-weight: bold;" id="totalPriceDisplay{{ a.id }}">TK {{ a.price }} BDT</p>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    
                                                                                    <button type="submit" 
                                                                                            style="width: 100%; padding: 12px; background-color: #0216adff; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer;">
                                                                                        Confirm Order
                                                                                    </button>
                                                                                </form>
                                                                            </div>
                                                                        </div>

                                                                        <script>
                                                                            // Function to open the order form modal
                                                                            function openOrderFormModal(productId) {
                                                                                // Get the currently selected size from the size selection buttons
                                                                                const selectedSizeBtn = document.querySelector(`#sizeContainer${productId} .size-btn.selected`);
                                                                                const selectedSize = selectedSizeBtn ? selectedSizeBtn.dataset.size : 'S';
                                                                                
                                                                                const quantity = document.getElementById(`qtyInput${productId}`).value;
                                                                                const price = {{ a.price }};
                                                                                const totalPrice = price * quantity;
                                                                                
                                                                                // Set the hidden fields with current selected values
                                                                                document.getElementById(`hiddenSize${productId}`).value = selectedSize;
                                                                                document.getElementById(`hiddenQuantity${productId}`).value = quantity;
                                                                                
                                                                                // Update the display in order form
                                                                                document.getElementById(`selectedSizeDisplay${productId}`).textContent = selectedSize;
                                                                                document.getElementById(`selectedQuantityDisplay${productId}`).textContent = quantity;
                                                                                document.getElementById(`totalPriceDisplay${productId}`).textContent = `TK ${totalPrice} BDT`;
                                                                                
                                                                                // Show the modal
                                                                                document.getElementById(`orderFormModal${productId}`).style.display = 'block';
                                                                            }
                                                                            
                                                                            // Character count for special instructions
                                                                            document.querySelectorAll('textarea[name="special_instructions"]').forEach(textarea => {
                                                                                textarea.addEventListener('input', function() {
                                                                                    const charCount = this.value.length;
                                                                                    const charCountElement = this.closest('.modal').querySelector('[id^="charCount"]');
                                                                                    if (charCountElement) {
                                                                                        charCountElement.textContent = charCount;
                                                                                    }
                                                                                });
                                                                            });
                                                                            
                                                                            // Close modal when clicking outside
                                                                            window.addEventListener('click', function(event) {
                                                                                document.querySelectorAll('[id^="orderFormModal"]').forEach(modal => {
                                                                                    if (event.target === modal) {
                                                                                        modal.style.display = 'none';
                                                                                    }
                                                                                });
                                                                            });
                                                                        </script>

                                                                    </div>
                                                                    <h2>About the Tailor</h2>
                                                                    
                                                                    <p>{{ a.tailor.user.first_name }} {{ a.tailor.user.last_name }}<br> {{a.tailor.business_name}}<br>{{a.tailor.business_location}}<br>{{ a.tailor.business_description }}</p>
                                                                    
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <script>
                                                            // Quantity control functions
                                                            function changeQty{{ a.id }}(delta) {
                                                                const input = document.getElementById("qtyInput{{ a.id }}");
                                                                let value = parseInt(input.value) || 1;
                                                                value += delta;
                                                                if (value < 1) value = 1;
                                                                if (value > 4) value = 4;
                                                                input.value = value;
                                                            }

                                                            // Make sure the DOM is loaded before attaching event listeners
                                                            document.addEventListener('DOMContentLoaded', function() {
                                                                // Initialize quantity input
                                                                const qtyInput = document.getElementById("qtyInput{{ a.id }}");
                                                                if (qtyInput) {
                                                                    qtyInput.addEventListener('change', function() {
                                                                        let value = parseInt(this.value) || 1;
                                                                        if (value < 1) this.value = 1;
                                                                        if (value > 4) this.value = 4;
                                                                    });
                                                                }
                                                            });
                                                            function changeMainImage(productId, imageUrl) {
                                                                document.getElementById('mainImage' + productId).src = imageUrl;
                                                            }

                                                            // Optional: Close modal on outside click
                                                            window.addEventListener("click", function(event) {
                                                                const modal = document.getElementById("orderModal{{ a.id }}");
                                                                if (event.target === modal) {
                                                                    modal.style.display = "none";
                                                                }
                                                            });

                                                            document.querySelector(`[data-bs-target="#orderModal{{ a.id }}"]`).addEventListener("click", function() {
                                                                document.getElementById("orderModal{{ a.id }}").style.display = "flex";
                                                            });
                                                            // Optional: Close modal on click outside
                                                            window.addEventListener("click", function(event) {
                                                            const modal = document.getElementById("orderModal{{ a.id }}");
                                                            if (event.target === modal) {
                                                                modal.style.display = "none";
                                                            }
                                                            });

                                                            // Show modal manually (no Bootstrap)
                                                            document.querySelector(`[data-bs-target="#orderModal{{ a.id }}"]`).addEventListener("click", function() {
                                                            document.getElementById("orderModal{{ a.id }}").style.display = "flex";
                                                            });
                                                        </script>




                                                    {% endif %}
                                                {% empty %}
                                                    <div style="text-align: center; padding: 20px; color: #666; grid-column: 1/-1;">
                                                        <i class="fas fa-images" style="font-size: 40px; margin-bottom: 10px;"></i>
                                                        <p>No portfolio items available</p>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>


                                        







                                        <div id="contactTab" class="tab-content" style="display: none;">
                                            <!-- Contact info will be loaded here -->
                                            <div style="padding: 10px;">
                                                <p><i class="fas fa-phone" style="margin-right: 10px;"></i> {{ tailor.phone|default:"Phone number not provided" }}</p>
                                                <p><i class="fas fa-envelope" style="margin-right: 10px;"></i> {{ tailor.user.email }}</p>
                                                <p><i class="fas fa-map-marker-alt" style="margin-right: 10px;"></i> {{ tailor.business_location }}</p>
                                            </div>
                                        </div>

                                        <script>
                                            // Tab functionality
                                            document.querySelectorAll('.tab-btn').forEach(btn => {
                                                btn.addEventListener('click', function() {
                                                    // Remove active class from all buttons
                                                    document.querySelectorAll('.tab-btn').forEach(b => {
                                                        b.classList.remove('active');
                                                        b.style.fontWeight = 'normal';
                                                        b.style.color = '#666';
                                                        b.style.borderBottom = 'none';
                                                    });
                                                    
                                                    // Add active class to clicked button
                                                    this.classList.add('active');
                                                    this.style.fontWeight = 'bold';
                                                    this.style.color = '#194afb';
                                                    this.style.borderBottom = '2px solid #194afb';
                                                    
                                                    // Hide all tab contents
                                                    document.querySelectorAll('.tab-content').forEach(content => {
                                                        content.style.display = 'none';
                                                    });
                                                    
                                                    // Show selected tab content
                                                    const tabId = this.getAttribute('data-tab') + 'Tab';
                                                    document.getElementById(tabId).style.display = 'block';
                                                });
                                            });
                                        </script>
                                        <!-- Form Section -->
                                        <button onclick="openCustomOrderModal('{{ tailor.id }}')" 
                                            style="display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #3498db; color: white; text-decoration: none; border: none; border-radius: 5px; cursor: pointer;">
                                            Custom Order
                                        </button>

                                        <div id="customOrderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 9999; font-family: 'Arial', sans-serif;">
                                            <div style="background: #fff; padding: 30px; border-radius: 8px; width: 700px; max-width: 95%; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;">
                                                
                                                <!-- Close Button -->
                                                <span class="close-custom-order-modal" data-modal-id="customOrderModal{{ tailor.id }}" 
                                                    style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 24px; color: #888; font-weight: bold;">
                                                    ✖
                                                </span>
                                                
                                                <!-- Modal Title -->
                                                <h3 style="font-size: 26px; color: #333; margin-bottom: 20px; font-weight: 700;">Custom Order</h3>
                                                        <!-- Progress Steps -->
                                                        <div style="display: flex; justify-content: center; margin-bottom: 20px;">
                                                            <div style="display: flex; align-items: center;">
                                                                <div class="step-circle active" data-step="1">1</div>
                                                                <div class="step-line"></div>
                                                                <div class="step-circle" data-step="2">2</div>
                                                                <div class="step-line"></div>
                                                                <div class="step-circle" data-step="3">3</div>
                                                                <div class="step-line"></div>
                                                                <div class="step-circle" data-step="4">4</div>
                                                            </div>
                                                        </div>

                                                        <form id="hireForm" method="POST" action="{% url 'create_custom_orders' tailor.id %}">
                                                            {% csrf_token %}
                                                            
                                                            <!-- Step 1: Basic Information -->
                                                            <div class="form-step active" data-step="1">
                                                                <h4 style="font-size: 20px; margin-bottom: 15px; color: #333;">Basic Information</h4>
                                                                
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Full Name*</label>
                                                                    <input type="text" name="full_name" value="{{ user.get_full_name }}" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;">
                                                                </div>
                                                                
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Phone Number*</label>
                                                                    <input type="tel" name="phone" value="{{ user.customer.phone }}" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;">
                                                                </div>
                                                                
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Email Address*</label>
                                                                    <input type="email" name="email" value="{{ user.email }}" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;">
                                                                </div>
                                                                
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Delivery Address*</label>
                                                                    <textarea name="address" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px; height: 80px;">{{ user.customer.address }}</textarea>
                                                                </div>
                                                                
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Gender*</label>
                                                                    <div style="display: flex; gap: 15px;">
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="gender" value="Men" required style="margin-right: 5px;"> Men
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="gender" value="Women" required style="margin-right: 5px;"> Women
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="gender" value="Unisex" required style="margin-right: 5px;"> Unisex
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                                                                    <button type="button" class="next-step" style="padding: 8px 20px; background-color: #194afb; color: white; border: none; border-radius: 5px; cursor: pointer;">Next</button>
                                                                </div>
                                                            </div>

                                                            <!-- Step 2: Garment Details -->
                                                            <div class="form-step" data-step="2">
                                                                <h4 style="font-size: 20px; margin-bottom: 15px; color: #333;">Garment Details</h4>
                                                                
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Garment Type*</label>
                                                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Panjabi" required style="margin-right: 5px;"> Panjabi
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Salwar Kameez" required style="margin-right: 5px;"> Salwar Kameez
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Formal Shirt" required style="margin-right: 5px;"> Formal Shirt
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Casual Shirt" required style="margin-right: 5px;"> Casual Shirt
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Suit" required style="margin-right: 5px;"> Suit
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Blazer" required style="margin-right: 5px;"> Blazer
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Saree Blouse" required style="margin-right: 5px;"> Saree Blouse
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Kurti" required style="margin-right: 5px;"> Kurti
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Dress" required style="margin-right: 5px;"> Dress
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Pant" required style="margin-right: 5px;"> Pant
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Shorts" required style="margin-right: 5px;"> Shorts
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Traditional Wear" required style="margin-right: 5px;"> Traditional Wear
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="radio" name="garment_type" value="Other" required style="margin-right: 5px;"> Other
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Occasion*</label>
                                                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Wedding" style="margin-right: 5px;"> Wedding
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Festival" style="margin-right: 5px;"> Festival
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Office/Formal" style="margin-right: 5px;"> Office/Formal
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Casual Daily Wear" style="margin-right: 5px;"> Casual Daily Wear
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Party/Event" style="margin-right: 5px;"> Party/Event
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Religious Ceremony" style="margin-right: 5px;"> Religious Ceremony
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Business Meeting" style="margin-right: 5px;"> Business Meeting
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Date Night" style="margin-right: 5px;"> Date Night
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Travel" style="margin-right: 5px;"> Travel
                                                                        </label>
                                                                        <label style="display: flex; align-items: center;">
                                                                            <input type="checkbox" name="occasion" value="Other" style="margin-right: 5px;"> Other
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                                
                                                                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                                                                    <button type="button" class="prev-step" style="padding: 8px 20px; background-color: #f0f0f0; color: #333; border: none; border-radius: 5px; cursor: pointer;">Previous</button>
                                                                    <button type="button" class="next-step" style="padding: 8px 20px; background-color: #194afb; color: white; border: none; border-radius: 5px; cursor: pointer;">Next</button>
                                                                </div>
                                                            </div>

                                                            <!-- Step 3: Measurements -->
                                                            <div class="form-step" data-step="3">
                                                                <h4 style="font-size: 20px; margin-bottom: 15px; color: #333;">Measurements (inches)</h4>
                                                                <p style="margin-bottom: 15px; color: #666;">Please provide your measurements in inches. Our tailor will verify these during consultation.</p>
                                                                
                                                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                                                                    <div>
                                                                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Chest/Bust*</label>
                                                                        <input type="number" name="chest" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;" placeholder="e.g. 38" step="0.1" min="20" max="60">
                                                                    </div>
                                                                    <div>
                                                                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Waist*</label>
                                                                        <input type="number" name="waist" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;" placeholder="e.g. 32" step="0.1" min="20" max="60">
                                                                    </div>
                                                                    <div>
                                                                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Hips*</label>
                                                                        <input type="number" name="hips" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;" placeholder="e.g. 36" step="0.1" min="20" max="60">
                                                                    </div>
                                                                </div>
                                                                
                                                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                                                                    <div>
                                                                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Sleeve Length*</label>
                                                                        <input type="number" name="sleeve_length" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;" placeholder="e.g. 24" step="0.1" min="10" max="40">
                                                                    </div>
                                                                    <div>
                                                                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Neck Length*</label>
                                                                        <input type="number" name="neck" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;" placeholder="e.g. 28" step="0.1" min="10" max="80">
                                                                    </div>
                                                                    <div>
                                                                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Shoulder Width*</label>
                                                                        <input type="number" name="shoulder_width" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;" placeholder="e.g. 16" step="0.1" min="10" max="30">
                                                                    </div>
                                                                </div>
                                                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
                                                                    <div>
                                                                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Inseam Length*</label>
                                                                        <input type="number" name="inseam" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;" placeholder="e.g. 24" step="0.1" min="10" max="40">
                                                                    </div>
                                                                    <div>
                                                                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Length*</label>
                                                                        <input type="number" name="length" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px;" placeholder="e.g. 24" step="0.1" min="10" max="40">
                                                                    </div>
                                                                </div>
                                                                
                                                                <div style="background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                                                                    <h5 style="font-size: 16px; margin-bottom: 10px; color: #333;">Measurement Tips:</h5>
                                                                    <ul style="margin: 0; padding-left: 20px; color: #666;">
                                                                        <li>Use a soft measuring tape</li>
                                                                        <li>Measure over light clothing</li>
                                                                        <li>Stand straight and relaxed</li>
                                                                        <li>Our tailor will take final measurements during consultation</li>
                                                                    </ul>
                                                                </div>
                                                                
                                                                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                                                                    <button type="button" class="prev-step" style="padding: 8px 20px; background-color: #f0f0f0; color: #333; border: none; border-radius: 5px; cursor: pointer;">Previous</button>
                                                                    <button type="button" class="next-step" style="padding: 8px 20px; background-color: #194afb; color: white; border: none; border-radius: 5px; cursor: pointer;">Next</button>
                                                                </div>
                                                            </div>

                                                            <!-- Step 4: Design Preferences -->
                                                            <div class="form-step" data-step="4">
                                                                <h4 style="font-size: 20px; margin-bottom: 15px; color: #333;">Design Preferences</h4>
                                                                
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Design Inspiration </label>
                                                                    <textarea name="design_inspiration" style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px; height: 80px;" placeholder="Share any design, reference images you have, or specific style preference..."></textarea>
                                                                </div>
                                                                
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Detailed Description*</label>
                                                                    <textarea name="description" required style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px; height: 120px;" placeholder="Describe your requirements in detail. Include any special features, embellishments, or specific requests"></textarea>
                                                                </div>
                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Special Note </label>
                                                                    <textarea name="special_request" style="width: 100%; padding: 8px; font-size: 15px; border: 1px solid #ccc; border-radius: 5px; height: 80px;" placeholder="Special request"></textarea>
                                                                </div>

                                                                <!-- Embroidery design section -->
                                                                <div style="margin-bottom: 15px;">
                                                                    <button type="button" id="embroideryBtn" style="padding: 8px 16px; background-color: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px;">
                                                                        <i class="fas fa-palette" style="margin-right: 5px;"></i> Add Embroidery Design
                                                                    </button>
                                                                    
                                                                    <!-- Selected Designs Display - Always visible -->
                                                                    <div id="selectedEmbroideryDisplay" style="background: #f8f9fa; padding: 12px; border-radius: 5px; margin-top: 10px;">
                                                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                                            <h5 style="font-size: 16px; margin: 0; color: #333;">Selected Embroidery Designs:</h5>
                                                                            <button type="button" id="clearEmbroideryBtn" style="padding: 4px 8px; background-color: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px; display: none;">
                                                                                Clear All
                                                                            </button>
                                                                        </div>
                                                                        <div id="selectedEmbroideryList" style="min-height: 20px;">
                                                                            <span style="color: #666; font-style: italic;">None</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <!-- Add this in the Design Preferences section (Step 4) after the embroidery section -->
                                                                <div style="margin-bottom: 15px;">
                                                                    <button type="button" id="fabricsBtn" style="padding: 8px 16px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px;">
                                                                        <i class="fas fa-tshirt" style="margin-right: 5px;"></i> Select Fabric
                                                                    </button>
                                                                    
                                                                    <!-- Selected Fabrics Display -->
                                                                    <div id="selectedFabricsDisplay" style="background: #f8f9fa; padding: 12px; border-radius: 5px; margin-top: 10px;">
                                                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                                            <h5 style="font-size: 16px; margin: 0; color: #333;">Selected Fabric:</h5>
                                                                            <button type="button" id="clearFabricsBtn" style="padding: 4px 8px; background-color: #f8f9fa; color: #666; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px; display: none;">
                                                                                Clear
                                                                            </button>
                                                                        </div>
                                                                        <div id="selectedFabricsList" style="min-height: 20px;">
                                                                            <span style="color: #666; font-style: italic;">None</span>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <!-- Add this tab button in the navigation tabs section -->
                                                                <button class="tab-btn" data-tab="fabrics" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: normal; color: #666;">Fabrics</button>

                                                                    <!-- Add this tab content in the tab content section -->
                                                                    <div id="fabricsTab" class="tab-content" style="display: none;">
                                                                        <!-- Header for Fabrics Tab -->
                                                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                                                            <h4 style="font-size: 18px; margin: 0; color: #333;">Available Fabrics</h4>
                                                                            <button type="button" id="saveFabricsBtn" style="padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                                                                <i class="fas fa-check" style="margin-right: 5px;"></i> Done
                                                                            </button>
                                                                        </div>
                                                                        
                                                                        <!-- Fabrics Cards Grid -->
                                                                        <div id="fabricsCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px;">
                                                                            {% for fabric in fabrics %}
                                                                                <div class="fabric-card" data-id="{{ fabric.id }}" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; cursor: pointer; transition: all 0.3s; position: relative;">
                                                                                    <div style="height: 120px; overflow: hidden;">
                                                                                        {% if fabric.image %}
                                                                                            <img src="{{ fabric.image.url }}" alt="{{ fabric.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                                                                        {% else %}
                                                                                            <div style="width: 100%; height: 100%; background: #f1f1f1; display: flex; align-items: center; justify-content: center; color: #777;">
                                                                                                <i class="fas fa-image" style="font-size: 24px;"></i>
                                                                                            </div>
                                                                                        {% endif %}
                                                                                    </div>
                                                                                    <div style="padding: 10px;">
                                                                                        <h6 style="margin: 0 0 5px 0; font-size: 14px; color: #333; font-weight: 600;">{{ fabric.name }}</h6>
                                                                                        <p style="margin: 0; font-size: 12px; color: #666;">{{ fabric.fabric_type }} • {{ fabric.color }}</p>
                                                                                        <p style="margin: 5px 0 0 0; font-size: 14px; font-weight: bold; color: #194afb;">৳{{ fabric.price_per_meter }}/meter</p>
                                                                                        <p style="margin: 2px 0 0 0; font-size: 12px; color: #666;">Available: {{ fabric.length_available }}m</p>
                                                                                    </div>
                                                                                    <div class="fabric-checkbox" style="position: absolute; top: 5px; right: 5px; display: none;">
                                                                                        <i class="fas fa-check-circle" style="color: #28a745; font-size: 20px;"></i>
                                                                                    </div>
                                                                                </div>
                                                                            {% empty %}
                                                                                <div style="text-align: center; padding: 20px; color: #666; grid-column: 1/-1;">
                                                                                    <i class="fas fa-tshirt" style="font-size: 40px; margin-bottom: 10px;"></i>
                                                                                    <p>No fabrics available</p>
                                                                                </div>
                                                                            {% endfor %}
                                                                            <!-- Hidden fields for fabric selection -->
                                                                            <input type="hidden" name="selected_fabric_id" id="selectedFabricId" value="">
                                                                            <input type="hidden" name="fabric_price" id="fabricPrice" value="0">
                                                                            <input type="hidden" name="fabric_length_needed" id="fabricLengthNeeded" value="0">
                                                                        </div>
                                                                        
                                                                        <!-- Fabric Length Input -->
                                                                        <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                                                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">Fabric Length Needed (meters)*</label>
                                                                            <input type="number" id="fabricLengthInput" min="0.5" max="10" step="0.1" value="2" 
                                                                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                                                                placeholder="Enter fabric length in meters">
                                                                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                                                                                Typical lengths: Shirt (2-2.5m), Pant (1.5-2m), Punjabi (3-4m)
                                                                            </p>
                                                                        </div>
                                                                    </div>

                                                                    <!-- Add this JavaScript for fabrics functionality -->
                                                                    <script>
                                                                        (function() {
                                                                            // Scope this script to the modal instance this script is inside
                                                                            const scriptEl = document.currentScript;
                                                                            const modal = scriptEl ? scriptEl.closest('#customOrderModal') : document.getElementById('customOrderModal');
                                                                            if (!modal) return;

                                                                            const fabricsBtn = modal.querySelector('#fabricsBtn');
                                                                            const fabricsTab = modal.querySelector('#fabricsTab');
                                                                            const saveFabricsBtn = modal.querySelector('#saveFabricsBtn');
                                                                            const fabricCards = modal.querySelectorAll('.fabric-card');
                                                                            const selectedFabricsDisplay = modal.querySelector('#selectedFabricsDisplay');
                                                                            const selectedFabricsList = modal.querySelector('#selectedFabricsList');
                                                                            const clearFabricsBtn = modal.querySelector('#clearFabricsBtn');
                                                                            const fabricLengthInput = modal.querySelector('#fabricLengthInput');
                                                                            
                                                                            // Store selected fabric data
                                                                            let selectedFabricId = null;
                                                                            let selectedFabricPrice = 0;
                                                                            let fabricLength = 2; // Default length

                                                                            // Function to show fabrics tab
                                                                            function showFabricsTab() {
                                                                                // Remove active class from all tab buttons (scoped to modal)
                                                                                modal.querySelectorAll('.tab-btn').forEach(btn => {
                                                                                    btn.classList.remove('active');
                                                                                    btn.style.fontWeight = 'normal';
                                                                                    btn.style.color = '#666';
                                                                                    btn.style.borderBottom = 'none';
                                                                                });
                                                                                
                                                                                // Add active class to fabrics tab button
                                                                                const fabricsTabBtn = modal.querySelector('[data-tab="fabrics"]');
                                                                                if (fabricsTabBtn) {
                                                                                    fabricsTabBtn.classList.add('active');
                                                                                    fabricsTabBtn.style.fontWeight = 'bold';
                                                                                    fabricsTabBtn.style.color = '#194afb';
                                                                                    fabricsTabBtn.style.borderBottom = '2px solid #194afb';
                                                                                }
                                                                                
                                                                                // Hide all tab contents inside modal
                                                                                modal.querySelectorAll('.tab-content').forEach(content => {
                                                                                    content.style.display = 'none';
                                                                                });
                                                                                
                                                                                // Show fabrics tab content
                                                                                if (fabricsTab) fabricsTab.style.display = 'block';
                                                                            }
                                                                            
                                                                            // Function to hide fabrics tab and go back to design tab
                                                                            function hideFabricsTab() {
                                                                                // Remove active class from fabrics tab button
                                                                                const fabricsTabBtn = modal.querySelector('[data-tab="fabrics"]');
                                                                                if (fabricsTabBtn) {
                                                                                    fabricsTabBtn.classList.remove('active');
                                                                                    fabricsTabBtn.style.fontWeight = 'normal';
                                                                                    fabricsTabBtn.style.color = '#666';
                                                                                    fabricsTabBtn.style.borderBottom = 'none';
                                                                                }
                                                                                
                                                                                // Hide fabrics tab content
                                                                                if (fabricsTab) fabricsTab.style.display = 'none';
                                                                                
                                                                                // Show design tab (assume aboutTab exists inside modal)
                                                                                const designTabBtn = modal.querySelector('[data-tab="about"]');
                                                                                if (designTabBtn) {
                                                                                    designTabBtn.classList.add('active');
                                                                                    designTabBtn.style.fontWeight = 'bold';
                                                                                    designTabBtn.style.color = '#194afb';
                                                                                    designTabBtn.style.borderBottom = '2px solid #194afb';
                                                                                    
                                                                                    const designTab = modal.querySelector('#aboutTab');
                                                                                    if (designTab) designTab.style.display = 'block';
                                                                                }
                                                                            }
                                                                            
                                                                            // Open fabrics tab when button is clicked
                                                                            if (fabricsBtn) {
                                                                                fabricsBtn.addEventListener('click', showFabricsTab);
                                                                            }
                                                                            
                                                                            // Save selection and go back to design
                                                                            if (saveFabricsBtn) {
                                                                                saveFabricsBtn.addEventListener('click', hideFabricsTab);
                                                                            }
                                                                            
                                                                            // Function to calculate fabric total price
                                                                            function calculateFabricTotalPrice() {
                                                                                const length = parseFloat(fabricLengthInput ? fabricLengthInput.value : 2) || 2;
                                                                                fabricLength = length;
                                                                                
                                                                                if (selectedFabricId) {
                                                                                    const card = modal.querySelector(`.fabric-card[data-id="${selectedFabricId}"]`);
                                                                                    if (card) {
                                                                                        const priceElement = card.querySelector('p:nth-child(3)');
                                                                                        if (priceElement) {
                                                                                            const priceText = priceElement.textContent;
                                                                                            const pricePerMeter = parseFloat(priceText.replace('৳', '').replace('/meter', '').trim()) || 0;
                                                                                            selectedFabricPrice = pricePerMeter * length;
                                                                                            
                                                                                            // Update hidden fields (scoped to modal)
                                                                                            const selFabricField = modal.querySelector('#selectedFabricId');
                                                                                            const fabricPriceField = modal.querySelector('#fabricPrice');
                                                                                            const fabricLengthField = modal.querySelector('#fabricLengthNeeded');
                                                                                            if (selFabricField) selFabricField.value = selectedFabricId;
                                                                                            if (fabricPriceField) fabricPriceField.value = selectedFabricPrice.toFixed(2);
                                                                                            if (fabricLengthField) fabricLengthField.value = length.toFixed(2);
                                                                                            
                                                                                            // Update display
                                                                                            updateFabricsSelectionDisplay();
                                                                                        }
                                                                                    }
                                                                                } else {
                                                                                    // No fabric selected
                                                                                    selectedFabricPrice = 0;
                                                                                    const selFabricField = modal.querySelector('#selectedFabricId');
                                                                                    const fabricPriceField = modal.querySelector('#fabricPrice');
                                                                                    const fabricLengthField = modal.querySelector('#fabricLengthNeeded');
                                                                                    if (selFabricField) selFabricField.value = '';
                                                                                    if (fabricPriceField) fabricPriceField.value = '0';
                                                                                    if (fabricLengthField) fabricLengthField.value = '0';
                                                                                    updateFabricsSelectionDisplay();
                                                                                }
                                                                            }

                                                                            // Handle fabric card selection
                                                                            fabricCards.forEach(card => {
                                                                                card.addEventListener('click', function() {
                                                                                    const fabricId = this.getAttribute('data-id');
                                                                                    
                                                                                    if (this.classList.contains('selected')) {
                                                                                        // Deselect
                                                                                        this.classList.remove('selected');
                                                                                        this.style.borderColor = '#ddd';
                                                                                        this.style.boxShadow = 'none';
                                                                                        const checkbox = this.querySelector('.fabric-checkbox');
                                                                                        if (checkbox) checkbox.style.display = 'none';
                                                                                        
                                                                                        // Remove selection
                                                                                        selectedFabricId = null;
                                                                                    } else {
                                                                                        // Deselect all other cards first (single selection)
                                                                                        fabricCards.forEach(c => {
                                                                                            c.classList.remove('selected');
                                                                                            c.style.borderColor = '#ddd';
                                                                                            c.style.boxShadow = 'none';
                                                                                            const checkbox = c.querySelector('.fabric-checkbox');
                                                                                            if (checkbox) checkbox.style.display = 'none';
                                                                                        });
                                                                                        
                                                                                        // Select current card
                                                                                        this.classList.add('selected');
                                                                                        this.style.borderColor = '#194afb';
                                                                                        this.style.boxShadow = '0 0 0 2px rgba(25, 74, 251, 0.2)';
                                                                                        const checkbox = this.querySelector('.fabric-checkbox');
                                                                                        if (checkbox) checkbox.style.display = 'block';
                                                                                        
                                                                                        // Set selection
                                                                                        selectedFabricId = fabricId;
                                                                                    }
                                                                                    
                                                                                    calculateFabricTotalPrice();
                                                                                });
                                                                            });
                                                                            
                                                                            // Update fabric price when length changes
                                                                            if (fabricLengthInput) {
                                                                                fabricLengthInput.addEventListener('input', calculateFabricTotalPrice);
                                                                                fabricLengthInput.addEventListener('change', calculateFabricTotalPrice);
                                                                            }
                                                                            
                                                                            // Function to update the display of selected fabric
                                                                            function updateFabricsSelectionDisplay() {
                                                                                if (selectedFabricId && selectedFabricsList) {
                                                                                    // Show clear button and update display
                                                                                    if (clearFabricsBtn) clearFabricsBtn.style.display = 'inline-block';
                                                                                    
                                                                                    // Clear current display
                                                                                    selectedFabricsList.innerHTML = '';
                                                                                    
                                                                                    // Add selected fabric to display
                                                                                    const card = modal.querySelector(`.fabric-card[data-id="${selectedFabricId}"]`);
                                                                                    if (card) {
                                                                                        const titleEl = card.querySelector('h6');
                                                                                        const title = titleEl ? titleEl.textContent : '';
                                                                                        const fabricTypeEl = card.querySelector('p:nth-child(2)');
                                                                                        const fabricType = fabricTypeEl ? fabricTypeEl.textContent : '';
                                                                                        
                                                                                        const item = document.createElement('div');
                                                                                        item.style.background = '#e9ecef';
                                                                                        item.style.padding = '10px';
                                                                                        item.style.borderRadius = '5px';
                                                                                        item.style.marginBottom = '10px';
                                                                                        item.innerHTML = `
                                                                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                                                                <div style="flex: 1;">
                                                                                                    <strong>${title}</strong><br>
                                                                                                    <small>${fabricType}</small><br>
                                                                                                    <small>Length: ${fabricLength.toFixed(2)}m</small>
                                                                                                </div>
                                                                                                <div style="text-align: right;">
                                                                                                    <strong>৳${selectedFabricPrice.toFixed(2)}</strong><br>
                                                                                                    <small style="color: #666;">(৳${(selectedFabricPrice/fabricLength).toFixed(2)}/m × ${fabricLength.toFixed(2)}m)</small>
                                                                                                </div>
                                                                                            </div>
                                                                                            <button type="button" class="remove-fabric-btn" style="margin-top: 5px; padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">
                                                                                                <i class="fas fa-times"></i> Remove
                                                                                            </button>
                                                                                        `;
                                                                                        selectedFabricsList.appendChild(item);
                                                                                        
                                                                                        // Add remove functionality
                                                                                        item.querySelector('.remove-fabric-btn').addEventListener('click', function(e) {
                                                                                            e.stopPropagation();
                                                                                            const cardToDeselect = modal.querySelector(`.fabric-card[data-id="${selectedFabricId}"]`);
                                                                                            if (cardToDeselect) {
                                                                                                cardToDeselect.classList.remove('selected');
                                                                                                cardToDeselect.style.borderColor = '#ddd';
                                                                                                cardToDeselect.style.boxShadow = 'none';
                                                                                                const checkbox = cardToDeselect.querySelector('.fabric-checkbox');
                                                                                                if (checkbox) checkbox.style.display = 'none';
                                                                                            }
                                                                                            
                                                                                            selectedFabricId = null;
                                                                                            calculateFabricTotalPrice();
                                                                                        });
                                                                                    }
                                                                                    
                                                                                } else if (selectedFabricsList) {
                                                                                    // Show "None" when no fabric selected
                                                                                    if (clearFabricsBtn) clearFabricsBtn.style.display = 'none';
                                                                                    selectedFabricsList.innerHTML = '<span style="color: #666; font-style: italic;">None</span>';
                                                                                    selectedFabricId = null; // Ensure it's empty
                                                                                }
                                                                            }
                                                                            
                                                                            // Clear fabric selection
                                                                            if (clearFabricsBtn) {
                                                                                clearFabricsBtn.addEventListener('click', function() {
                                                                                    // Deselect all cards
                                                                                    fabricCards.forEach(card => {
                                                                                        card.classList.remove('selected');
                                                                                        card.style.borderColor = '#ddd';
                                                                                        card.style.boxShadow = 'none';
                                                                                        const checkbox = card.querySelector('.fabric-checkbox');
                                                                                        if (checkbox) checkbox.style.display = 'none';
                                                                                    });
                                                                                    
                                                                                    // Clear selected ID and price
                                                                                    selectedFabricId = null;
                                                                                    selectedFabricPrice = 0;
                                                                                    
                                                                                    // Update hidden fields (scoped)
                                                                                    const selFabricField = modal.querySelector('#selectedFabricId');
                                                                                    const fabricPriceField = modal.querySelector('#fabricPrice');
                                                                                    const fabricLengthField = modal.querySelector('#fabricLengthNeeded');
                                                                                    if (selFabricField) selFabricField.value = '';
                                                                                    if (fabricPriceField) fabricPriceField.value = '0';
                                                                                    if (fabricLengthField) fabricLengthField.value = '0';
                                                                                    
                                                                                    // Update display
                                                                                    updateFabricsSelectionDisplay();
                                                                                });
                                                                            }
                                                                            
                                                                            // Initialize display
                                                                            calculateFabricTotalPrice();
                                                                        })();
                                                                    </script>

                                                                <!-- Add this tab button in the navigation tabs section -->
                                                                <button class="tab-btn" data-tab="embroidery" style="padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: normal; color: #666;">Embroidery</button>

                                                                <!-- Add this tab content in the tab content section -->
                                                                <div id="embroideryTab" class="tab-content" style="display: none;">
                                                                    <!-- Header for Embroidery Tab -->
                                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                                                        <h4 style="font-size: 18px; margin: 0; color: #333;">Embroidery Designs</h4>
                                                                        <button type="button" id="saveEmbroideryBtn" style="padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                                                            <i class="fas fa-check" style="margin-right: 5px;"></i> Done
                                                                        </button>
                                                                    </div>
                                                                    
                                                                    <!-- Embroidery Cards Grid -->
                                                                    <div id="embroideryCards" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px;">
                                                                        {% for design in embroidery %}
                                                                            <div class="embroidery-card" data-id="{{ design.id }}" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; cursor: pointer; transition: all 0.3s; position: relative;">
                                                                                <div style="height: 120px; overflow: hidden;">
                                                                                    {% if design.design_image %}
                                                                                        <img src="{{ design.design_image.url }}" alt="{{ design.title }}" style="width: 100%; height: 100%; object-fit: cover;">
                                                                                    {% else %}
                                                                                        <div style="width: 100%; height: 100%; background: #f1f1f1; display: flex; align-items: center; justify-content: center; color: #777;">
                                                                                            <i class="fas fa-image" style="font-size: 24px;"></i>
                                                                                        </div>
                                                                                    {% endif %}
                                                                                </div>
                                                                                <div style="padding: 10px;">
                                                                                    <h6 style="margin: 0 0 5px 0; font-size: 14px; color: #333; font-weight: 600;">{{ design.title }}</h6>
                                                                                    <p style="margin: 0; font-size: 12px; color: #666;">{{ design.fabric_type|default:"Various fabrics" }}</p>
                                                                                    <p style="margin: 5px 0 0 0; font-size: 14px; font-weight: bold; color: #194afb;">৳{{ design.price }}</p>
                                                                                </div>
                                                                                <div class="embroidery-checkbox" style="position: absolute; top: 5px; right: 5px; display: none;">
                                                                                    <i class="fas fa-check-circle" style="color: #28a745; font-size: 20px;"></i>
                                                                                </div>
                                                                            </div>
                                                                        {% empty %}
                                                                            <div style="text-align: center; padding: 20px; color: #666; grid-column: 1/-1;">
                                                                                <i class="fas fa-palette" style="font-size: 40px; margin-bottom: 10px;"></i>
                                                                                <p>No embroidery designs available</p>
                                                                            </div>
                                                                        {% endfor %}
                                                                        <!-- Hidden fields for embroidery selection -->
                                                                        <input type="hidden" name="selected_embroidery_ids" id="selectedEmbroideryIds" value="">
                                                                        <input type="hidden" name="embroidery_total_price" id="embroideryTotalPrice" value="0">
                                                                    </div>
                                                                </div>

                                                                <script>
                                                                    (function() {
                                                                        // Scope this script to the modal instance this script is inside
                                                                        const scriptEl = document.currentScript;
                                                                        const modal = scriptEl ? scriptEl.closest('#customOrderModal') : document.getElementById('customOrderModal');
                                                                        if (!modal) return;

                                                                        // Initialize embroidery functionality (scoped)
                                                                        const embroideryBtn = modal.querySelector('#embroideryBtn');
                                                                        const embroideryTab = modal.querySelector('#embroideryTab');
                                                                        const saveEmbroideryBtn = modal.querySelector('#saveEmbroideryBtn');
                                                                        const embroideryCards = modal.querySelectorAll('.embroidery-card');
                                                                        const selectedEmbroideryDisplay = modal.querySelector('#selectedEmbroideryDisplay');
                                                                        const selectedEmbroideryList = modal.querySelector('#selectedEmbroideryList');
                                                                        const clearEmbroideryBtn = modal.querySelector('#clearEmbroideryBtn');
                                                                        
                                                                        // Store selected embroidery data
                                                                        let selectedEmbroideryIds = [];
                                                                        let embroideryTotalPrice = 0;

                                                                        // Function to show embroidery tab
                                                                        function showEmbroideryTab() {
                                                                            // Remove active class from all tab buttons inside modal
                                                                            modal.querySelectorAll('.tab-btn').forEach(btn => {
                                                                                btn.classList.remove('active');
                                                                                btn.style.fontWeight = 'normal';
                                                                                btn.style.color = '#666';
                                                                                btn.style.borderBottom = 'none';
                                                                            });
                                                                            
                                                                            // Add active class to embroidery tab button
                                                                            const embroideryTabBtn = modal.querySelector('[data-tab="embroidery"]');
                                                                            if (embroideryTabBtn) {
                                                                                embroideryTabBtn.classList.add('active');
                                                                                embroideryTabBtn.style.fontWeight = 'bold';
                                                                                embroideryTabBtn.style.color = '#194afb';
                                                                                embroideryTabBtn.style.borderBottom = '2px solid #194afb';
                                                                            }
                                                                            
                                                                            // Hide all tab contents inside modal
                                                                            modal.querySelectorAll('.tab-content').forEach(content => {
                                                                                content.style.display = 'none';
                                                                            });
                                                                            
                                                                            // Show embroidery tab content
                                                                            if (embroideryTab) embroideryTab.style.display = 'block';
                                                                        }
                                                                        
                                                                        // Function to hide embroidery tab and go back to design tab
                                                                        function hideEmbroideryTab() {
                                                                            // Remove active class from embroidery tab button
                                                                            const embroideryTabBtn = modal.querySelector('[data-tab="embroidery"]');
                                                                            if (embroideryTabBtn) {
                                                                                embroideryTabBtn.classList.remove('active');
                                                                                embroideryTabBtn.style.fontWeight = 'normal';
                                                                                embroideryTabBtn.style.color = '#666';
                                                                                embroideryTabBtn.style.borderBottom = 'none';
                                                                            }
                                                                            
                                                                            // Hide embroidery tab content
                                                                            if (embroideryTab) embroideryTab.style.display = 'none';
                                                                            
                                                                            // Show design tab (Step 4 - Design Preferences)
                                                                            const designTabBtn = modal.querySelector('[data-tab="about"]');
                                                                            if (designTabBtn) {
                                                                                designTabBtn.classList.add('active');
                                                                                designTabBtn.style.fontWeight = 'bold';
                                                                                designTabBtn.style.color = '#194afb';
                                                                                designTabBtn.style.borderBottom = '2px solid #194afb';
                                                                                
                                                                                const designTab = modal.querySelector('#aboutTab');
                                                                                if (designTab) designTab.style.display = 'block';
                                                                            }
                                                                        }
                                                                        
                                                                        // Open embroidery tab when button is clicked
                                                                        if (embroideryBtn) {
                                                                            embroideryBtn.addEventListener('click', function(e) {
                                                                                e.preventDefault();
                                                                                showEmbroideryTab();
                                                                            });
                                                                        }
                                                                        
                                                                        // Save selection and go back to design
                                                                        if (saveEmbroideryBtn) {
                                                                            saveEmbroideryBtn.addEventListener('click', function(e) {
                                                                                e.preventDefault();
                                                                                hideEmbroideryTab();
                                                                            });
                                                                        }
                                                                        
                                                                        // Function to calculate total embroidery price
                                                                        function calculateEmbroideryTotalPrice() {
                                                                            embroideryTotalPrice = 0;
                                                                            
                                                                            selectedEmbroideryIds.forEach(id => {
                                                                                const card = modal.querySelector(`.embroidery-card[data-id="${id}"]`);
                                                                                if (card) {
                                                                                    const priceElement = card.querySelector('p:nth-child(3)'); // Third paragraph contains price
                                                                                    if (priceElement) {
                                                                                        const priceText = priceElement.textContent;
                                                                                        const price = parseFloat(priceText.replace('৳', '').trim()) || 0;
                                                                                        embroideryTotalPrice += price;
                                                                                    }
                                                                                }
                                                                            });
                                                                            
                                                                            // Update hidden fields (scoped)
                                                                            const selectedEmbroideryIdsField = modal.querySelector('#selectedEmbroideryIds');
                                                                            const embroideryTotalPriceField = modal.querySelector('#embroideryTotalPrice');
                                                                            
                                                                            if (selectedEmbroideryIdsField) selectedEmbroideryIdsField.value = selectedEmbroideryIds.join(',');
                                                                            if (embroideryTotalPriceField) embroideryTotalPriceField.value = embroideryTotalPrice.toFixed(2);
                                                                            
                                                                            // Update display
                                                                            updateEmbroiderySelectionDisplay();
                                                                        }

                                                                        // Handle embroidery card selection
                                                                        embroideryCards.forEach(card => {
                                                                            card.addEventListener('click', function() {
                                                                                const designId = this.getAttribute('data-id');
                                                                                
                                                                                if (this.classList.contains('selected')) {
                                                                                    // Deselect
                                                                                    this.classList.remove('selected');
                                                                                    this.style.borderColor = '#ddd';
                                                                                    this.style.boxShadow = 'none';
                                                                                    const checkbox = this.querySelector('.embroidery-checkbox');
                                                                                    if (checkbox) checkbox.style.display = 'none';
                                                                                    
                                                                                    // Remove from selection
                                                                                    const index = selectedEmbroideryIds.indexOf(designId);
                                                                                    if (index > -1) selectedEmbroideryIds.splice(index, 1);
                                                                                } else {
                                                                                    // Select - allow multiple selection for embroidery
                                                                                    this.classList.add('selected');
                                                                                    this.style.borderColor = '#194afb';
                                                                                    this.style.boxShadow = '0 0 0 2px rgba(25, 74, 251, 0.2)';
                                                                                    const checkbox = this.querySelector('.embroidery-checkbox');
                                                                                    if (checkbox) checkbox.style.display = 'block';
                                                                                    
                                                                                    // Add to selection
                                                                                    if (!selectedEmbroideryIds.includes(designId)) selectedEmbroideryIds.push(designId);
                                                                                }
                                                                                
                                                                                calculateEmbroideryTotalPrice();
                                                                            });
                                                                        });
                                                                        
                                                                        // Function to update the display of selected embroidery
                                                                        function updateEmbroiderySelectionDisplay() {
                                                                            if (!selectedEmbroideryList) return;
                                                                            
                                                                            if (selectedEmbroideryIds.length > 0) {
                                                                                // Show clear button and update display
                                                                                if (clearEmbroideryBtn) clearEmbroideryBtn.style.display = 'inline-block';
                                                                                
                                                                                // Clear current display
                                                                                selectedEmbroideryList.innerHTML = '';
                                                                                
                                                                                // Add selected items to display
                                                                                selectedEmbroideryIds.forEach(id => {
                                                                                    const card = modal.querySelector(`.embroidery-card[data-id="${id}"]`);
                                                                                    if (card) {
                                                                                        const title = card.querySelector('h6').textContent;
                                                                                        const priceElement = card.querySelector('p:nth-child(3)');
                                                                                        const price = priceElement ? priceElement.textContent : '৳0';
                                                                                        
                                                                                        const item = document.createElement('div');
                                                                                        item.style.display = 'inline-flex';
                                                                                        item.style.alignItems = 'center';
                                                                                        item.style.background = '#e9ecef';
                                                                                        item.style.padding = '8px 12px';
                                                                                        item.style.borderRadius = '15px';
                                                                                        item.style.margin = '0 8px 8px 0';
                                                                                        item.style.fontSize = '14px';
                                                                                        item.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                                                                                        item.innerHTML = `
                                                                                            <span style="margin-right: 8px;">${title} ${price}</span>
                                                                                            <span class="remove-btn" data-id="${id}" style="cursor: pointer; color: #dc3545; font-weight: bold; padding: 2px 6px; border-radius: 50%; background: white;">
                                                                                                <i class="fas fa-times"></i>
                                                                                            </span>
                                                                                        `;
                                                                                        selectedEmbroideryList.appendChild(item);
                                                                                        
                                                                                        // Add remove functionality
                                                                                        item.querySelector('.remove-btn').addEventListener('click', function(e) {
                                                                                            e.stopPropagation();
                                                                                            const removeId = this.getAttribute('data-id');
                                                                                            const cardToDeselect = modal.querySelector(`.embroidery-card[data-id="${removeId}"]`);
                                                                                            if (cardToDeselect) {
                                                                                                cardToDeselect.classList.remove('selected');
                                                                                                cardToDeselect.style.borderColor = '#ddd';
                                                                                                cardToDeselect.style.boxShadow = 'none';
                                                                                                const checkbox = cardToDeselect.querySelector('.embroidery-checkbox');
                                                                                                if (checkbox) checkbox.style.display = 'none';
                                                                                            }
                                                                                            
                                                                                            const index = selectedEmbroideryIds.indexOf(removeId);
                                                                                            if (index > -1) selectedEmbroideryIds.splice(index, 1);
                                                                                            calculateEmbroideryTotalPrice();
                                                                                        });
                                                                                    }
                                                                                });
                                                                                
                                                                                // Show total embroidery price
                                                                                const totalItem = document.createElement('div');
                                                                                totalItem.style.marginTop = '12px';
                                                                                totalItem.style.padding = '8px 12px';
                                                                                totalItem.style.fontWeight = 'bold';
                                                                                totalItem.style.color = '#194afb';
                                                                                totalItem.style.background = '#e6f2ff';
                                                                                totalItem.style.borderRadius = '5px';
                                                                                totalItem.style.border = '1px solid #194afb';
                                                                                totalItem.textContent = `Total Embroidery Cost: ৳${embroideryTotalPrice.toFixed(2)}`;
                                                                                selectedEmbroideryList.appendChild(totalItem);
                                                                                
                                                                            } else {
                                                                                // Show "None" when no designs selected
                                                                                if (clearEmbroideryBtn) clearEmbroideryBtn.style.display = 'none';
                                                                                selectedEmbroideryList.innerHTML = '<span style="color: #666; font-style: italic; padding: 10px; display: block;">No embroidery designs selected</span>';
                                                                                selectedEmbroideryIds = []; // Ensure it's empty
                                                                            }
                                                                        }
                                                                        
                                                                        // Clear all embroidery selections
                                                                        if (clearEmbroideryBtn) {
                                                                            clearEmbroideryBtn.addEventListener('click', function(e) {
                                                                                e.preventDefault();
                                                                                
                                                                                // Deselect all cards
                                                                                embroideryCards.forEach(card => {
                                                                                    card.classList.remove('selected');
                                                                                    card.style.borderColor = '#ddd';
                                                                                    card.style.boxShadow = 'none';
                                                                                    const checkbox = card.querySelector('.embroidery-checkbox');
                                                                                    if (checkbox) checkbox.style.display = 'none';
                                                                                });
                                                                                
                                                                                // Clear selected IDs and price
                                                                                selectedEmbroideryIds = [];
                                                                                embroideryTotalPrice = 0;
                                                                                
                                                                                // Update hidden fields (scoped)
                                                                                const selectedEmbroideryIdsField = modal.querySelector('#selectedEmbroideryIds');
                                                                                const embroideryTotalPriceField = modal.querySelector('#embroideryTotalPrice');
                                                                                if (selectedEmbroideryIdsField) selectedEmbroideryIdsField.value = '';
                                                                                if (embroideryTotalPriceField) embroideryTotalPriceField.value = '0';
                                                                                
                                                                                // Update display
                                                                                updateEmbroiderySelectionDisplay();
                                                                            });
                                                                        }
                                                                        
                                                                        // Close embroidery tab when clicking outside (optional)
                                                                        document.addEventListener('click', function(e) {
                                                                            if (embroideryTab && embroideryTab.style.display === 'block') {
                                                                                if (!embroideryTab.contains(e.target) && e.target !== embroideryBtn) {
                                                                                    hideEmbroideryTab();
                                                                                }
                                                                            }
                                                                        });
                                                                        
                                                                        // Initialize display
                                                                        calculateEmbroideryTotalPrice();
                                                                    })();
                                                                </script>




                                                                <div style="margin-bottom: 15px;">
                                                                    <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333;">Delivery Information</label>
                                                                    <div style="background: #f8f9fa; padding: 12px; border-radius: 5px; border: 1px solid #e9ecef;">
                                                                        <p style="margin: 0; color: #28a745; font-weight: 500;">
                                                                            <i class="fas fa-shipping-fast" style="margin-right: 8px;"></i>
                                                                            Your order will be delivered within 21 working days
                                                                        </p>
                                                                        <p style="margin: 5px 0 0 0; font-size: 14px; color: #666;">
                                                                            Estimated delivery: <strong id="estimatedDeliveryDate"></strong>
                                                                        </p>

                                                                        <script>
                                                                            document.addEventListener('DOMContentLoaded', function() {
                                                                                function calculateEstimatedDelivery() {
                                                                                    const today = new Date();
                                                                                    
                                                                                    // Add 21 days
                                                                                    const deliveryDate = new Date(today);
                                                                                    deliveryDate.setDate(deliveryDate.getDate() + 21);
                                                                                    
                                                                                    // Format the date as "Month Day, Year"
                                                                                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                                                                                                'July', 'August', 'September', 'October', 'November', 'December'];
                                                                                    
                                                                                    const month = months[deliveryDate.getMonth()];
                                                                                    const day = deliveryDate.getDate();
                                                                                    const year = deliveryDate.getFullYear();
                                                                                    
                                                                                    const formattedDate = `${month} ${day}, ${year}`;
                                                                                    
                                                                                    // Display the date
                                                                                    document.getElementById('estimatedDeliveryDate').textContent = formattedDate;
                                                                                }
                                                                                
                                                                                // Calculate and display on page load
                                                                                calculateEstimatedDelivery();
                                                                            });
                                                                        </script>
                                                                    </div>
                                                                    <input type="hidden" name="delivery_date" value="{{ estimated_delivery_date|date:'Y-m-d' }}">
                                                                </div>
                                                                
                                                                
                                                                <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                                                                    <button type="button" class="prev-step" style="padding: 8px 20px; background-color: #f0f0f0; color: #333; border: none; border-radius: 5px; cursor: pointer;">Previous</button>
                                                                    <button type="submit" style="padding: 8px 20px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Submit Order</button>
                                                                </div>
                                                            </div>
                                                        </form>
                                                        
                                                        <style>
                                                            .step-circle {
                                                                width: 30px;
                                                                height: 30px;
                                                                border-radius: 50%;
                                                                background-color: #ddd;
                                                                color: #666;
                                                                display: flex;
                                                                align-items: center;
                                                                justify-content: center;
                                                                font-weight: bold;
                                                            }
                                                            
                                                            .step-circle.active {
                                                                background-color: #194afb;
                                                                color: white;
                                                            }
                                                            
                                                            .step-line {
                                                                width: 40px;
                                                                height: 2px;
                                                                background-color: #ddd;
                                                            }
                                                            
                                                            .form-step {
                                                                display: none;
                                                            }
                                                            
                                                            .form-step.active {
                                                                display: block;
                                                            }
                                                        </style>
                                                        
                                                        <script>
                                                            // Fix for modal opening/closing
                                                            document.addEventListener('DOMContentLoaded', function() {
                                                                // Event delegation for opening modals
                                                                document.addEventListener('click', function(e) {
                                                                    if (e.target.classList.contains('open-modal-btn')) {
                                                                        const tailorId = e.target.getAttribute('data-id');
                                                                        const modalId = 'hireModal' + tailorId;
                                                                        const modal = document.getElementById(modalId);
                                                                        if (modal) {
                                                                            modal.style.display = 'flex';
                                                                            
                                                                            // Set modal content
                                                                            const tailorImage = modal.querySelector('#tailorImage');
                                                                            const tailorName = modal.querySelector('#tailorName');
                                                                            const tailorshopname = modal.querySelector('#tailorshopname');
                                                                            const tailorLocation = modal.querySelector('#tailorLocation');
                                                                            const tailorRating = modal.querySelector('#tailorRating');
                                                                            const modalTitle = modal.querySelector('#modalTitle');
                                                                            
                                                                            if (tailorImage) tailorImage.src = e.target.getAttribute('data-image');
                                                                            if (tailorName) tailorName.textContent = e.target.getAttribute('data-name');
                                                                            if (tailorshopname) tailorshopname.textContent = e.target.getAttribute('data-shop');
                                                                            if (tailorLocation) tailorLocation.textContent = e.target.getAttribute('data-location');
                                                                            if (tailorRating) tailorRating.textContent = e.target.getAttribute('data-rating') + ' ⭐';
                                                                            if (modalTitle) modalTitle.textContent = 'Order ' + e.target.getAttribute('data-name');
                                                                            
                                                                            // Set form action
                                                                            const form = modal.querySelector('#hireForm');
                                                                            if (form) form.action = e.target.getAttribute('data-url');
                                                                        }
                                                                    }
                                                                    
                                                                    // Close modal when clicking close button
                                                                    if (e.target.classList.contains('close-modal')) {
                                                                        const modalId = e.target.getAttribute('data-modal-id');
                                                                        const modal = document.getElementById(modalId);
                                                                        if (modal) {
                                                                            modal.style.display = 'none';
                                                                        }
                                                                    }
                                                                    
                                                                    // Close modal when clicking outside
                                                                    if (e.target.classList.contains('hire-modal')) {
                                                                        e.target.style.display = 'none';
                                                                    }
                                                                });

                                                                // Open custom order modal - ensure modal-local values are computed before submit
                                                                function openCustomOrderModal(tailorId) {
                                                                    // Find the parent modal first
                                                                    const parentModal = document.getElementById('hireModal' + tailorId);
                                                                    if (!parentModal) return;

                                                                    // Find the custom order modal within the parent modal
                                                                    const customOrderModal = parentModal.querySelector('#customOrderModal');
                                                                    if (!customOrderModal) return;

                                                                    customOrderModal.style.display = "flex";

                                                                    // Set the form action dynamically
                                                                    const hireForm = customOrderModal.querySelector("#hireForm");
                                                                    if (hireForm) {
                                                                        hireForm.action = `/create-custom-orders/${tailorId}/`;
                                                                    }

                                                                    // Attach a one-time submit-time updater to ensure hidden inputs inside the modal are set from modal-local selections
                                                                    if (!customOrderModal.dataset.orderSubmitHook) {
                                                                        if (hireForm) {
                                                                            hireForm.addEventListener('submit', function(e) {
                                                                                try {
                                                                                    // --- Embroidery: compute selected IDs and total from this modal ---
                                                                                    const selectedEmbroideryField = customOrderModal.querySelector('#selectedEmbroideryIds');
                                                                                    const embroideryTotalField = customOrderModal.querySelector('#embroideryTotalPrice');
                                                                                    let selectedEmbroidery = [];
                                                                                    let embroideryTotal = 0;
                                                                                    customOrderModal.querySelectorAll('.embroidery-card.selected').forEach(card => {
                                                                                        const id = card.getAttribute('data-id');
                                                                                        if (id) selectedEmbroidery.push(id);
                                                                                        // price is inside a <p> element that contains the '৳' symbol; find the first <p> with price text
                                                                                        const priceEl = card.querySelector('p:nth-of-type(3)') || card.querySelector('p:last-of-type');
                                                                                        if (priceEl) {
                                                                                            const txt = priceEl.textContent || '';
                                                                                            const price = parseFloat(txt.replace(/[^0-9.]/g, '')) || 0;
                                                                                            embroideryTotal += price;
                                                                                        }
                                                                                    });
                                                                                    if (selectedEmbroideryField) selectedEmbroideryField.value = selectedEmbroidery.join(',');
                                                                                    if (embroideryTotalField) embroideryTotalField.value = embroideryTotal.toFixed(2);

                                                                                    // --- Fabrics: compute selected fabric, length and total price from this modal ---
                                                                                    const selectedFabricField = customOrderModal.querySelector('#selectedFabricId');
                                                                                    const fabricPriceField = customOrderModal.querySelector('#fabricPrice');
                                                                                    const fabricLengthField = customOrderModal.querySelector('#fabricLengthNeeded');

                                                                                    let selectedFabric = null;
                                                                                    let fabricTotal = 0;
                                                                                    let fabricLength = 0;

                                                                                    // read length input inside modal if present
                                                                                    const lengthInput = customOrderModal.querySelector('#fabricLengthInput');
                                                                                    if (lengthInput) {
                                                                                        fabricLength = parseFloat(lengthInput.value) || 0;
                                                                                    }

                                                                                    const fabricCard = customOrderModal.querySelector('.fabric-card.selected');
                                                                                    if (fabricCard) {
                                                                                        selectedFabric = fabricCard.getAttribute('data-id');
                                                                                        const priceTextEl = fabricCard.querySelector('p:nth-of-type(3)') || fabricCard.querySelector('p:last-of-type');
                                                                                        if (priceTextEl) {
                                                                                            // priceText contains something like '৳123/meter' or '৳123'
                                                                                            const txt = priceTextEl.textContent || '';
                                                                                            const perMeter = parseFloat(txt.replace(/[^0-9.]/g, '')) || 0;
                                                                                            fabricTotal = perMeter * (fabricLength || 0);
                                                                                        }
                                                                                    }

                                                                                    if (selectedFabricField) selectedFabricField.value = selectedFabric || '';
                                                                                    if (fabricPriceField) fabricPriceField.value = fabricTotal.toFixed(2);
                                                                                    if (fabricLengthField) fabricLengthField.value = (fabricLength ? fabricLength.toFixed(2) : '0');

                                                                                } catch (err) {
                                                                                    // Don't block submission; log for debugging
                                                                                    console.warn('Error preparing modal data for submit', err);
                                                                                }
                                                                                // allow submit to continue
                                                                            });
                                                                        }
                                                                        customOrderModal.dataset.orderSubmitHook = '1';
                                                                    }

                                                                    // Initialize per-modal step behavior (keeps existing behavior)
                                                                    initStepsForModal(customOrderModal);
                                                                }
                                                                
                                                                // Close custom order modal
                                                                document.addEventListener('click', function(e) {
                                                                    // Close custom order modal when clicking close button
                                                                    if (e.target.classList.contains('close-custom-order-modal')) {
                                                                        const customOrderModal = e.target.closest('#customOrderModal');
                                                                        if (customOrderModal) {
                                                                            customOrderModal.style.display = 'none';
                                                                        }
                                                                    }
                                                                    
                                                                    // Close custom order modal when clicking outside
                                                                    if (e.target.id === "customOrderModal") {
                                                                        e.target.style.display = "none";
                                                                    }
                                                                });

                                                                // Step navigation functionality for hire form
                                                                function initStepsForModal(modal) {
                                                                    const steps = modal.querySelectorAll('.form-step');
                                                                    const stepCircles = modal.querySelectorAll('.step-circle');
                                                                    
                                                                    function showStep(stepNumber) {
                                                                        // Hide all steps in this modal
                                                                        steps.forEach(step => {
                                                                            step.classList.remove('active');
                                                                            step.style.display = 'none';
                                                                        });
                                                                        
                                                                        // Show current step
                                                                        const currentStep = modal.querySelector(`.form-step[data-step="${stepNumber}"]`);
                                                                        if (currentStep) {
                                                                            currentStep.classList.add('active');
                                                                            currentStep.style.display = 'block';
                                                                        }
                                                                        
                                                                        // Update step circles
                                                                        stepCircles.forEach(circle => {
                                                                            const circleStep = parseInt(circle.dataset.step);
                                                                            if (circleStep <= stepNumber) {
                                                                                circle.classList.add('active');
                                                                            } else {
                                                                                circle.classList.remove('active');
                                                                            }
                                                                        });
                                                                    }

                                                                    // Next button click handler for this modal
                                                                    modal.querySelectorAll('.next-step').forEach(button => {
                                                                        button.addEventListener('click', function() {
                                                                            const currentStep = this.closest('.form-step');
                                                                            const nextStep = parseInt(currentStep.dataset.step) + 1;
                                                                            if (nextStep <= steps.length) {
                                                                                showStep(nextStep);
                                                                            }
                                                                        });
                                                                    });

                                                                    // Previous button click handler for this modal
                                                                    modal.querySelectorAll('.prev-step').forEach(button => {
                                                                        button.addEventListener('click', function() {
                                                                            const currentStep = this.closest('.form-step');
                                                                            const prevStep = parseInt(currentStep.dataset.step) - 1;
                                                                            if (prevStep >= 1) {
                                                                                showStep(prevStep);
                                                                            }
                                                                        });
                                                                    });

                                                                    // Form submission handler
                                                                    const hireForm = modal.querySelector('#hireForm');
                                                                    if (hireForm) {
                                                                        hireForm.addEventListener('submit', function(e) {
                                                                            // Validate form before submission
                                                                            if (validateForm(this)) {
                                                                                // Form is valid, allow submission
                                                                                console.log('Form submitted successfully');
                                                                                // You can add loading indicator or other UI feedback here
                                                                            } else {
                                                                                // Form is invalid, prevent submission
                                                                                e.preventDefault();
                                                                                alert('Please fill all required fields correctly.');
                                                                            }
                                                                        });
                                                                    }

                                                                    // Initialize first step
                                                                    showStep(1);
                                                                }

                                                                // Form validation function
                                                                function validateForm(form) {
                                                                    let isValid = true;
                                                                    const requiredFields = form.querySelectorAll('[required]');
                                                                    
                                                                    requiredFields.forEach(field => {
                                                                        if (!field.value.trim()) {
                                                                            isValid = false;
                                                                            field.style.borderColor = '#e74c3c';
                                                                        } else {
                                                                            field.style.borderColor = '#ccc';
                                                                        }
                                                                    });

                                                                    // Validate measurements are numbers
                                                                    const measurementFields = form.querySelectorAll('input[type="number"]');
                                                                    measurementFields.forEach(field => {
                                                                        if (field.value && isNaN(field.value)) {
                                                                            isValid = false;
                                                                            field.style.borderColor = '#e74c3c';
                                                                        }
                                                                    });

                                                                    return isValid;
                                                                }

                                                                // Tab functionality for all modals
                                                                document.querySelectorAll('.hire-modal').forEach(modal => {
                                                                    modal.addEventListener('click', function(e) {
                                                                        if (e.target.classList.contains('tab-btn')) {
                                                                            // Remove active class from all buttons in this modal
                                                                            const tabButtons = this.querySelectorAll('.tab-btn');
                                                                            tabButtons.forEach(btn => {
                                                                                btn.classList.remove('active');
                                                                                btn.style.fontWeight = 'normal';
                                                                                btn.style.color = '#666';
                                                                                btn.style.borderBottom = 'none';
                                                                            });
                                                                            
                                                                            // Add active class to clicked button
                                                                            e.target.classList.add('active');
                                                                            e.target.style.fontWeight = 'bold';
                                                                            e.target.style.color = '#194afb';
                                                                            e.target.style.borderBottom = '2px solid #194afb';
                                                                            
                                                                            // Hide all tab contents in this modal
                                                                            const tabContents = this.querySelectorAll('.tab-content');
                                                                            tabContents.forEach(content => {
                                                                                content.style.display = 'none';
                                                                            });
                                                                            
                                                                            // Show selected tab content
                                                                            const tabId = e.target.getAttribute('data-tab') + 'Tab';
                                                                            const tabContent = this.querySelector('#' + tabId);
                                                                            if (tabContent) {
                                                                                tabContent.style.display = 'block';
                                                                            }
                                                                        }
                                                                    });
                                                                });

                                                                // Make openCustomOrderModal function globally available
                                                                window.openCustomOrderModal = openCustomOrderModal;

                                                                // Initialize all custom order modals when they are opened
                                                                document.querySelectorAll('#customOrderModal').forEach(modal => {
                                                                    // They will be initialized when opened via openCustomOrderModal
                                                                });
                                                            });
                                                        </script>

                                            </div>
                                        </div>

                                        
                                        

                                    </div>
                                </div>
                                {% else %}
                                    <a href="{% url 'user_login' %}" style="display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #e74c3c; color: white; text-decoration: none; border-radius: 5px;">Login to view profile</a>
                                {% endif %}
                            </div>    
                        </div>
                    {% endif %}
                {% endfor %}
                <!-- Additional CSS for Hover Effect and Slideshow -->
                <style>
                    .cover-slider-container:hover .cover-slider {
                        animation: slide 20s infinite;
                    }

                    .cover-slider-container {
                        cursor: pointer;
                    }

                    /* Animation to cycle through the images */
                    @keyframes slide {
                        0% { transform: translateX(0); }
                        25% { transform: translateX(-100%); }
                        50% { transform: translateX(-200%); }
                        75% { transform: translateX(-300%); }
                        100% { transform: translateX(-400%); }
                    }
                </style>

            </div>
        </div>        
        
    </section>

</main>


{% endblock %}